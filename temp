#!/bin/bash
set -e

USER="radio"
URL="https://www.radio-nederland.nl"

echo "Stap 1: Vereiste packages installeren..."
apt update
apt install -y xserver-xorg xinit firefox-esr dbus-x11

echo "Stap 2: Controleren of user $USER bestaat..."
if ! id "$USER" &>/dev/null; then
    echo "User $USER bestaat nog niet, maken..."
    adduser --disabled-password --gecos "" "$USER"
fi

echo "Stap 3: Oude kiosk setup opruimen..."
# Oude .xsession
rm -f /home/$USER/.xsession

# Oude getty override
if [ -d /etc/systemd/system/getty@tty1.service.d ]; then
    rm -rf /etc/systemd/system/getty@tty1.service.d
    systemctl daemon-reload
fi

# Stop oude kiosk service (indien aanwezig)
if systemctl list-units --full -all | grep -q "kiosk"; then
    systemctl stop kiosk.service || true
    systemctl disable kiosk.service || true
fi

echo "Stap 4: Nieuwe .xsession aanmaken..."
mkdir -p /home/$USER
cat > /home/$USER/.xsession <<EOF
#!/bin/sh
xset s off
xset -dpms
xset s noblank
sleep 1
exec firefox --no-remote --disable-features=TranslateUI --kiosk "$URL"
EOF
chown $USER:$USER /home/$USER/.xsession
chmod +x /home/$USER/.xsession

echo "Stap 5: Auto-login op tty1 instellen..."
mkdir -p /etc/systemd/system/getty@tty1.service.d
cat > /etc/systemd/system/getty@tty1.service.d/override.conf <<EOF
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin $USER --noclear %I \$TERM
EOF
systemctl daemon-reload
systemctl restart getty@tty1

echo "Stap 6: .bash_profile aanpassen zodat X automatisch start bij login..."
grep -q "# Start X automatisch op tty1" /home/$USER/.bash_profile || cat >> /home/$USER/.bash_profile <<'EOF'

# Start X automatisch op tty1
if [[ -z $DISPLAY ]] && [[ $(tty) == /dev/tty1 ]]; then
    exec startx /home/radio/.xsession
fi
EOF
chown $USER:$USER /home/$USER/.bash_profile

echo "Klaar! Herstart de machine om Firefox automatisch in kiosk-mode te starten."

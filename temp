#!/bin/bash
set -e

URL="https://www.radio-nederland.nl"
USER="radio"

echo "Stap 1: Installeren van vereiste packages..."
apt update
apt install -y xserver-xorg xinit firefox-esr

echo "Stap 2: Controleren of user $USER bestaat..."
if ! id "$USER" &>/dev/null; then
    echo "User $USER bestaat nog niet, maken..."
    adduser --disabled-password --gecos "" "$USER"
fi

echo "Stap 3: .xsession aanmaken voor $USER..."
cat > /home/$USER/.xsession <<EOF
#!/bin/sh
xset s off
xset -dpms
xset s noblank
sleep 1
exec firefox --kiosk "$URL"
EOF
chown $USER:$USER /home/$USER/.xsession
chmod +x /home/$USER/.xsession

echo "Stap 4: Auto-login op tty1 instellen..."
mkdir -p /etc/systemd/system/getty@tty1.service.d
cat > /etc/systemd/system/getty@tty1.service.d/override.conf <<EOF
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin $USER --noclear %I \$TERM
EOF

echo "Stap 5: .bash_profile aanpassen zodat X automatisch start..."
cat >> /home/$USER/.bash_profile <<'EOF'

# Start X automatisch op tty1
if [[ -z $DISPLAY ]] && [[ $(tty) == /dev/tty1 ]]; then
    exec startx
fi
EOF
chown $USER:$USER /home/$USER/.bash_profile

echo "Klaar! Herstart nu de machine om Firefox in kiosk-mode automatisch te starten."

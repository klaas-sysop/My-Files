#!/bin/bash
set -e

USER="radio"
URL="https://www.radio-nederland.nl"

echo "Stap 1: Oude kiosk service verwijderen..."
if systemctl list-units --full -all | grep -q "kiosk.service"; then
    systemctl stop kiosk.service || true
    systemctl disable kiosk.service || true
    rm -f /etc/systemd/system/kiosk.service
    systemctl daemon-reload
    systemctl reset-failed
    echo "Oude kiosk.service verwijderd."
else
    echo "Geen oude kiosk.service gevonden."
fi

echo "Stap 2: Oude .xsession of .bash_profile wijzigingen verwijderen..."
if [ -f /home/$USER/.xsession ]; then
    rm -f /home/$USER/.xsession
    echo "Oude .xsession verwijderd."
fi

# Verwijder auto-start X regel in .bash_profile
if [ -f /home/$USER/.bash_profile ]; then
    sed -i '/# Start X automatisch op tty1/,+3d' /home/$USER/.bash_profile || true
    echo "Oude X start regels in .bash_profile verwijderd."
fi

# Verwijder oude override voor getty@tty1.service
if [ -d /etc/systemd/system/getty@tty1.service.d ]; then
    rm -rf /etc/systemd/system/getty@tty1.service.d
    systemctl daemon-reload
    echo "Oude auto-login override verwijderd."
fi

echo "Stap 3: Nieuwe kiosk setup installeren..."

# .xsession maken
cat > /home/$USER/.xsession <<EOF
#!/bin/sh
xset s off
xset -dpms
xset s noblank
sleep 1
exec firefox --kiosk "$URL"
EOF
chown $USER:$USER /home/$USER/.xsession
chmod +x /home/$USER/.xsession

# Auto-login op tty1 instellen
mkdir -p /etc/systemd/system/getty@tty1.service.d
cat > /etc/systemd/system/getty@tty1.service.d/override.conf <<EOF
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin $USER --noclear %I \$TERM
EOF

# .bash_profile aanpassen voor automatisch starten van X
grep -q "# Start X automatisch op tty1" /home/$USER/.bash_profile || cat >> /home/$USER/.bash_profile <<'EOF'

# Start X automatisch op tty1
if [[ -z $DISPLAY ]] && [[ $(tty) == /dev/tty1 ]]; then
    exec startx
fi
EOF
chown $USER:$USER /home/$USER/.bash_profile

echo "Klaar! Herstart de machine om de nieuwe kiosk setup te testen."
